# =============================================================================
# Caddy Reverse Proxy Configuration
# Automatic HTTPS with Let's Encrypt
# =============================================================================

# Global options
{
	# Email for Let's Encrypt notifications
	email {{ADMIN_EMAIL}}
	
	# Uncomment for staging certificates during testing
	# acme_ca https://acme-staging-v02.api.letsencrypt.org/directory
}

# Health check endpoint (internal only)
:80 {
	respond /health 200
}

# =============================================================================
# Matrix Homeserver (Conduit)
# =============================================================================

{{MATRIX_DOMAIN}} {
	encode gzip zstd

	log {
		output stdout
		format console
		level INFO
	}

	# --- CORS for Element (browser clients) ---
	@cors header Origin *
	header @cors {
		Access-Control-Allow-Origin "{http.request.header.Origin}"
		Vary "Origin"
		Access-Control-Allow-Methods "GET,POST,PUT,DELETE,OPTIONS"
		Access-Control-Allow-Headers "Authorization,Content-Type,Accept,Origin,X-Requested-With"
		Access-Control-Expose-Headers "Location"
		Access-Control-Max-Age 86400
	}

	@options method OPTIONS
	respond @options 204

	# Well-known endpoints
	handle /.well-known/matrix/client {
		header Content-Type application/json
		respond `{"m.homeserver":{"base_url":"https://{{MATRIX_DOMAIN}}"}}`
	}

	handle /.well-known/matrix/server {
		header Content-Type application/json
		respond `{"m.server":"{{MATRIX_DOMAIN}}:443"}`
	}

	# LiveKit JWT Service for Element Call
	handle /_livekit/* {
		uri strip_prefix /_livekit
		reverse_proxy livekit-jwt:8080
	}

	# Reverse proxy to Conduit
	reverse_proxy conduit:6167 {
		header_up Host {host}
		header_up X-Real-IP {remote_host}
		header_up X-Forwarded-For {remote_host}
		header_up X-Forwarded-Proto {scheme}

		transport http {
			read_timeout 90s
			write_timeout 90s
		}
	}
}

# =============================================================================
# Matrix Federation (Port 8448)
# =============================================================================

{{MATRIX_DOMAIN}}:8448 {
	# TLS for federation
	tls {
		protocols tls1.2 tls1.3
	}
	
	encode gzip zstd
	
	reverse_proxy conduit:6167 {
		header_up Host {host}
		header_up X-Real-IP {remote_host}
		header_up X-Forwarded-For {remote_host}
		header_up X-Forwarded-Proto {scheme}
	}
}

# =============================================================================
# LiveKit Server
# =============================================================================

{{LIVEKIT_DOMAIN}} {
	encode gzip zstd
	
	log {
		output stdout
		format console
		level INFO
	}
	
	# LiveKit API and WebSocket
	reverse_proxy livekit:7880 {
		header_up Host {host}
		header_up X-Real-IP {remote_host}
		header_up X-Forwarded-For {remote_host}
		header_up X-Forwarded-Proto {scheme}
		
		# WebSocket support
		transport http {
			read_timeout 0
			write_timeout 0
		}
	}
}

# =============================================================================
# Well-known files for Matrix delegation (if using a different base domain)
# =============================================================================

# Uncomment if your base domain is different from your Matrix domain
# example.com {
# 	# Matrix client well-known
# 	handle /.well-known/matrix/client {
# 		header Content-Type application/json
# 		header Access-Control-Allow-Origin *
# 		respond `{"m.homeserver":{"base_url":"https://matrix.example.com"}}`
# 	}
# 	
# 	# Matrix server well-known (federation)
# 	handle /.well-known/matrix/server {
# 		header Content-Type application/json
# 		respond `{"m.server":"matrix.example.com:443"}`
# 	}
# 	
# 	# Other traffic
# 	handle {
# 		# Your other site content
# 	}
# }
